name: CI

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      localstack:
        image: "localstack/localstack:1.4"
        ports:
          - 4566:4566
        env:
          - SERVICES=s3,dynamodb,lambda
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: Install dependencies
        run: npm ci
      - name: Start LocalStack (wait)
        run: |
          docker run -d -p 4566:4566 -e SERVICES=s3,dynamodb localstack/localstack:1.4 || true
          sleep 10
          # Create S3 bucket for PDFs
          aws --endpoint-url=http://localhost:4566 s3api create-bucket --bucket placeholder-bucket || true
      - name: Configure AWS for LocalStack
        run: |
          export AWS_ACCESS_KEY_ID=test; export AWS_SECRET_ACCESS_KEY=test; export AWS_REGION=us-east-1
      - name: Create DynamoDB tables (LocalStack)
        env:
          AWS_ENDPOINT_URL: http://localhost:4566
        run: |
          aws --endpoint-url=http://localhost:4566 dynamodb create-table --table-name fincalc-pdf-exports --attribute-definitions AttributeName=id,AttributeType=S --key-schema AttributeName=id,KeyType=HASH --billing-mode PAY_PER_REQUEST || true
      - name: Run tests
        env:
          AWS_ENDPOINT_URL: http://localhost:4566
        run: npm test --silent

  migration-dry-run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
      - name: Install dependencies
        run: npm ci
      - name: Run migration dry-run
        env:
          DDB_PDF_EXPORTS_TABLE: fincalc-pdf-exports
          DDB_CLIENTS_TABLE: fincalc-clients
          DDB_USERS_TABLE: fincalc-users
          AWS_S3_BUCKET: placeholder-bucket
        run: npm run migrate:prisma-to-ddb:dry || true
      - name: Upload migration report
        uses: actions/upload-artifact@v4
        with:
          name: migration-report
          path: tmp/migration-report-*.json

  build-image-on-release:
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Login to AWS ECR
        uses: aws-actions/amazon-ecr-login@v1
      - name: Build and push PDF function image
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
          AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
          ECR_REPO: pdf-generator
          IMAGE_TAG: ${{ github.sha }}
        run: |
          ./scripts/build-pdf-function-image.sh
