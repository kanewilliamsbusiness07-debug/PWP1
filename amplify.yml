version: 1
frontend:
  phases:
    preBuild:
      commands:
        - mkdir -p ~/.npm
        - npm config set cache ~/.npm --global
        - node scripts/check-amplify-env.js
        - npm ci
        - node scripts/check-env.js || true
        - npx prisma generate
        - |
          if [ -n "$DATABASE_URL" ]; then
            echo "Running database migrations..."
            npx prisma migrate deploy || echo "Warning: Migration failed or no migrations to apply"
          else
            echo "Skipping migrations: DATABASE_URL not set"
          fi
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - ~/.npm/**/*
      - .next/cache/**/*
      - .prisma/**/*

