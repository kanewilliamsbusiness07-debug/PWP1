generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  passwordHash      String
  name              String
  role              String    @default("ADVISOR")
  isMasterAdmin     Boolean   @default(false)
  isActive          Boolean   @default(true)
  twoFactorSecret   String?
  twoFactorEnabled  Boolean   @default(false)
  loginAttempts     Int       @default(0)
  lockedUntil       DateTime?
  lastLogin         DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  clients           Client[]
  appointments      Appointment[]
  emailIntegration  EmailIntegration?
  recentClientAccess RecentClientAccess[]
  emailTemplates     EmailTemplate[]
  inboundEmails     InboundEmail[]
}

model Client {
  id                String    @id @default(cuid())
  userId            String    
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  firstName         String
  middleName        String?
  lastName          String
  dob               DateTime
  maritalStatus     String
  numberOfDependants Int      @default(0)
  agesOfDependants  String?
  email             String?
  mobile            String?
  addressLine1      String?
  addressLine2      String?
  suburb            String?
  state             String?
  postcode          String?
  ownOrRent         String?
  isDraft           Boolean   @default(false)
  
  // Canonical Financial Fields
  annualIncome      Float?   // Canonical field for income
  grossSalary       Float?   // Synonymous with annualIncome
  employmentIncome  Float?   // Synonymous with annualIncome
  grossIncome       Float?   // Synonymous with annualIncome
  
  // Assets - Real Estate
  homePrice         Float?
  homeYear          Int?
  homeValue         Float?
  investment1Price  Float?
  investment1Year   Int?
  investment1Value  Float?
  investment2Price  Float?
  investment2Year   Int?
  investment2Value  Float?
  investment3Price  Float?
  investment3Year   Int?
  investment3Value  Float?
  investment4Price  Float?
  investment4Year   Int?
  investment4Value  Float?

  // Liabilities - Real Estate
  homeFunder        String?
  homeBalance       Float?
  homeRate          Float?
  homeRepayment     Float?
  investment1Funder String?
  investment1Balance Float?
  investment1Rate   Float?
  investment1Repayment Float?
  investment2Funder String?
  investment2Balance Float?
  investment2Rate   Float?
  investment2Repayment Float?
  investment3Funder String?
  investment3Balance Float?
  investment3Rate   Float?
  investment3Repayment Float?
  investment4Funder String?
  investment4Balance Float?
  investment4Rate   Float?
  investment4Repayment Float?

  // Assets - Other
  vehicleType       String?
  vehicleYear       Int?
  vehicleValue      Float?
  savingsValue      Float?
  homeContentsValue Float?
  superFundValue    Float?
  superFundTime     Int?
  sharesValue       Float?
  sharesTotalValue  Float?

  // Liabilities - Other
  creditCardLimit   Float?
  creditCardBalance Float?
  personalLoanRepayment Float?
  personalLoanBalance Float?
  hecsRepayment    Float?
  hecsBalance      Float?

  // Additional financial fields from forms
  rentalIncome      Float?
  dividends         Float?
  frankedDividends  Float?
  capitalGains      Float?
  otherIncome       Float?
  investmentIncome  Float?
  monthlyRentalIncome Float?
  currentAge        Int?
  retirementAge     Int?
  currentSuper      Float?
  currentSavings    Float?
  currentShares     Float?
  propertyEquity    Float?
  monthlyDebtPayments Float?
  workRelatedExpenses Float?
  vehicleExpenses   Float?
  uniformsAndLaundry Float?
  homeOfficeExpenses Float?
  selfEducationExpenses Float?
  investmentExpenses Float?
  charityDonations  Float?
  accountingFees    Float?
  rentalExpenses    Float?
  superContributions Float?
  healthInsurance   Boolean?
  hecs              Boolean?
  helpDebt          Float?
  privateHealthInsurance Boolean?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  appointments      Appointment[]
  recentAccess      RecentClientAccess[]
  inboundEmails     InboundEmail[]

  @@index([userId])
  @@index([email])
}

model EmailIntegration {
  id                String    @id @default(cuid())
  userId            String    @unique
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider          String    // 'GMAIL', 'OUTLOOK', 'IMAP', 'SMTP'
  email             String
  encryptedAccessToken String? // For OAuth providers
  encryptedRefreshToken String? // For OAuth providers
  encryptedPassword  String?   // For IMAP/SMTP (encrypted)
  smtpHost          String?
  smtpPort          Int?
  smtpUser          String?
  imapHost          String?
  imapPort          Int?
  imapUser          String?
  isActive          Boolean   @default(true)
  lastSyncAt        DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model Appointment {
  id                String    @id @default(cuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  clientId          String
  client            Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  title             String
  description       String?
  startDateTime     DateTime
  endDateTime       DateTime
  status            String    @default("SCHEDULED") // SCHEDULED, COMPLETED, CANCELLED, RESCHEDULED
  notes             String?
  reminderSent      Boolean   @default(false)
  reminderSentAt    DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([userId])
  @@index([clientId])
  @@index([startDateTime])
}

model RecentClientAccess {
  id                String    @id @default(cuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  clientId          String
  client            Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  accessedAt        DateTime  @default(now())

  @@unique([userId, clientId])
  @@index([userId, accessedAt])
}

model EmailTemplate {
  id                String    @id @default(cuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name              String
  subject           String
  body              String    // HTML template with merge fields
  mergeFields       String[]  // Array of available merge fields
  isDefault         Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([userId])
}

model InboundEmail {
  id                String    @id @default(cuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  clientId          String?   // Linked client if sender matches
  client            Client?   @relation(fields: [clientId], references: [id], onDelete: SetNull)
  fromEmail         String
  fromName          String?
  subject           String
  body              String
  htmlBody          String?
  receivedAt        DateTime
  isRead            Boolean   @default(false)
  isLinked          Boolean   @default(false)
  createdAt         DateTime  @default(now())

  @@index([userId])
  @@index([clientId])
  @@index([fromEmail])
  @@index([receivedAt])
}

model FieldMapping {
  id                String    @id @default(cuid())
  synonym           String    @unique // e.g., "grossSalary", "grossIncome", "employmentIncome"
  canonicalField    String    // e.g., "annualIncome"
  fieldType         String    // "income", "asset", "liability", "expense", etc.
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([canonicalField])
}
